/**
 * spidermix 0.1.0
 * © 2024 (Tayira)
 */

(function (global) {
  "use strict";

  // تحسين الأداء وتحميل الموارد
  function optimizeHTML() {
    const body = document.body;
    body.innerHTML = body.innerHTML.replace(/>\s+</g, "><"); // تحديث الـ DOM في دفعة واحدة
  }

  function optimizeScripts() {
    document.querySelectorAll("script").forEach((script) => {
      if (!script.src.includes("unpkg.com/@babel/standalone")) {
        script.defer = true; // تأجيل تحميل السكريبتات غير الضرورية
      }
    });
  }

  function lazyLoadResources() {
    document.querySelectorAll("img, iframe").forEach((el) => {
      el.loading = "lazy"; // تحميل الصور و iframes بشكل كسول
    });
  }

  function optimizeCSS() {
    document.querySelectorAll('link[rel="stylesheet"]').forEach((link) => {
      link.media = "print"; // تأجيل تحميل CSS
      link.addEventListener("load", () => {
        link.media = "all";
      });
    });
  }

  function optimizeAll() {
    optimizeHTML();
    optimizeScripts();
    lazyLoadResources();
    optimizeCSS();
  }

  document.addEventListener("DOMContentLoaded", optimizeAll);

  // تسجيل Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("/service-worker.js") // استخدام المسار النسبي
        .then((registration) => {
          console.log(
            "Service Worker registered with scope:",
            registration.scope
          );
        })
        .catch((error) => {
          console.error("Service Worker registration failed:", error);
        });
    });
  }

  function animate() {
    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);

  function debounce(func, wait) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  window.addEventListener(
    "resize",
    debounce(() => {
      
    }, 250)
  );

  global.spidermix = {
    version: "0.1.0",
    optimizeAll: optimizeAll,
  };
})(window);
